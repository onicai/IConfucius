name: verify-wasm

on:
  workflow_dispatch:

env:
  DFX_VERSION: "0.29.2"
  DFX_WARNING: "-mainnet_plaintext_identity"

jobs:
  verify-wasm:
    name: verify-wasm ${{ matrix.canister }} (Docker)
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        canister: [IConfucius]

    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: install dfx
        run: |
          set -euo pipefail
          DFXVM_INIT_YES=true sh -ci "$(curl -fsSL https://sdk.dfinity.org/install.sh)"
          source "$HOME/.local/share/dfx/env"
          echo "$HOME/.local/share/dfx/bin" >> $GITHUB_PATH
          dfxvm default $DFX_VERSION

      - name: create default identity
        run: dfx identity get-principal > /dev/null 2>&1

      - name: versions
        run: |
          echo "Runner OS   : $RUNNER_OS"
          echo "Architecture: $(uname -m)"
          echo "OS version  : $(lsb_release -d 2>/dev/null | cut -f2)"
          echo "dfx version : $(dfx --version)"
          echo "Docker      : $(docker --version)"

      - name: build Docker base image
        working-directory: src/${{ matrix.canister }}
        run: make docker-build-base

      - name: build wasm with Docker
        working-directory: src/${{ matrix.canister }}
        run: make docker-build-wasm

      - name: verify wasm hash matches deployed canister
        working-directory: src/${{ matrix.canister }}
        run: |
          set -euo pipefail
          LOCAL_HASH=$(shasum -a 256 out/out_Linux_x86_64.wasm | cut -d ' ' -f 1)
          echo "Docker wasm hash:   $LOCAL_HASH"
          DEPLOYED_HASH=$(dfx canister info iconfucius_ctrlb_canister --network ic | grep "Module hash:" | sed 's/Module hash: 0x//')
          echo "Deployed wasm hash: $DEPLOYED_HASH"
          if [ "$LOCAL_HASH" = "$DEPLOYED_HASH" ]; then
            echo "✅ MATCH: Docker build matches deployed canister iconfucius_ctrlb_canister"
          else
            echo "❌ MISMATCH: Docker build does NOT match deployed canister iconfucius_ctrlb_canister"
            exit 1
          fi
